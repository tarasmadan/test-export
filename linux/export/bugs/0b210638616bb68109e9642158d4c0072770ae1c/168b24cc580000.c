// https://syzkaller.appspot.com/bug?id=0b210638616bb68109e9642158d4c0072770ae1c
// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE

#include <dirent.h>
#include <endian.h>
#include <errno.h>
#include <fcntl.h>
#include <signal.h>
#include <stdarg.h>
#include <stdbool.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/prctl.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <sys/wait.h>
#include <time.h>
#include <unistd.h>

#ifndef __NR_bpf
#define __NR_bpf 321
#endif

static unsigned long long procid;

static void sleep_ms(uint64_t ms)
{
  usleep(ms * 1000);
}

static uint64_t current_time_ms(void)
{
  struct timespec ts;
  if (clock_gettime(CLOCK_MONOTONIC, &ts))
    exit(1);
  return (uint64_t)ts.tv_sec * 1000 + (uint64_t)ts.tv_nsec / 1000000;
}

static bool write_file(const char* file, const char* what, ...)
{
  char buf[1024];
  va_list args;
  va_start(args, what);
  vsnprintf(buf, sizeof(buf), what, args);
  va_end(args);
  buf[sizeof(buf) - 1] = 0;
  int len = strlen(buf);
  int fd = open(file, O_WRONLY | O_CLOEXEC);
  if (fd == -1)
    return false;
  if (write(fd, buf, len) != len) {
    int err = errno;
    close(fd);
    errno = err;
    return false;
  }
  close(fd);
  return true;
}

static void kill_and_wait(int pid, int* status)
{
  kill(-pid, SIGKILL);
  kill(pid, SIGKILL);
  for (int i = 0; i < 100; i++) {
    if (waitpid(-1, status, WNOHANG | __WALL) == pid)
      return;
    usleep(1000);
  }
  DIR* dir = opendir("/sys/fs/fuse/connections");
  if (dir) {
    for (;;) {
      struct dirent* ent = readdir(dir);
      if (!ent)
        break;
      if (strcmp(ent->d_name, ".") == 0 || strcmp(ent->d_name, "..") == 0)
        continue;
      char abort[300];
      snprintf(abort, sizeof(abort), "/sys/fs/fuse/connections/%s/abort",
               ent->d_name);
      int fd = open(abort, O_WRONLY);
      if (fd == -1) {
        continue;
      }
      if (write(fd, abort, 1) < 0) {
      }
      close(fd);
    }
    closedir(dir);
  } else {
  }
  while (waitpid(-1, status, __WALL) != pid) {
  }
}

static void setup_test()
{
  prctl(PR_SET_PDEATHSIG, SIGKILL, 0, 0, 0);
  setpgrp();
  write_file("/proc/self/oom_score_adj", "1000");
}

static void execute_one(void);

#define WAIT_FLAGS __WALL

static void loop(void)
{
  int iter = 0;
  for (;; iter++) {
    int pid = fork();
    if (pid < 0)
      exit(1);
    if (pid == 0) {
      setup_test();
      execute_one();
      exit(0);
    }
    int status = 0;
    uint64_t start = current_time_ms();
    for (;;) {
      sleep_ms(10);
      if (waitpid(-1, &status, WNOHANG | WAIT_FLAGS) == pid)
        break;
      if (current_time_ms() - start < 5000)
        continue;
      kill_and_wait(pid, &status);
      break;
    }
  }
}

uint64_t r[2] = {0xffffffffffffffff, 0xffffffffffffffff};

void execute_one(void)
{
  intptr_t res = 0;
  if (write(1, "executing program\n", sizeof("executing program\n") - 1)) {
  }
  *(uint32_t*)0x200000000240 = 0;
  *(uint32_t*)0x200000000244 = -1;
  *(uint32_t*)0x200000000248 = 0;
  *(uint32_t*)0x20000000024c = 7;
  *(uint64_t*)0x200000000250 = 0x200000000000;
  memcpy((void*)0x200000000000, "cgroup\000", 7);
  syscall(__NR_bpf, /*cmd=*/0x14ul, /*arg=*/0x200000000240ul, /*size=*/0x30ul);
  res = syscall(__NR_openat, /*fd=*/0xffffffffffffff9cul,
                /*file=*/0x200000000000ul, /*flags=*/0x200002, /*mode=*/0);
  if (res != -1)
    r[0] = res;
  *(uint32_t*)0x200000000080 = 9;
  *(uint32_t*)0x200000000084 = 4;
  *(uint64_t*)0x200000000088 = 0x2000000008c0;
  memcpy(
      (void*)0x2000000008c0,
      "\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x61\x12"
      "\x00\x00\x00\x00\x00\x00\x95\x00\x00\x00\x00\x00\x00\x00\x51\xfa\x78\x24"
      "\xc7\x41\x86\xdc\x02\xec\x06\x96\xc3\x7b\x64\xe3\xb2\x4d\xa3\x18\x01\x00"
      "\x00\x00\x05\x16\x5c\x0f\x63\xcd\xc2\xe8\x28\x18\x25\x49\x50\xee\x03\x56"
      "\x8b\x88\x09\xa1\xff\x4c\x7c\x47\x50\xea\xbf\xaf\xcb\x95\x31\xb3\x1e\x6a"
      "\x86\x82\x7d\x10\x10\xc5\xa9\x09\xab\x98\xe0\x0e\x19\x64\x4a\x88\xe9\x5b"
      "\xa2\x6d\x1c\x9e\xec\xdd\xb2\xd1\x1c\x54\x14\x18\xce\xeb\x29\xb9\xb6\x82"
      "\x9c\x6e\x43\x38\x22\xbd\xb3\xcc\x85\x24\x4a\xab\x60\xc1\xaa\xe1\x31\x4d"
      "\x73\x81\xfc\xfe\xb9\x70\xbe\xa6\x72\xcf\x1e\x92\x6f\x6a\x51\x47\x93\x43"
      "\x14\x46\x48\xa0\x7a\x97\x5b\xd8\x9d\xc3\x98\x71\x23\x76\x61\x0f\x62\x54"
      "\xf1\x24\x95\xb4\x65\x83\x19\x68\x43\x87\xf6\xf3\x54\x32\x05\xd4\xbc\x4c"
      "\xe0\x5b\x8b\x96\x11\x03\x67\x3d\xff\x7f\x15\x80\x52\xe6\x2b\x20\xf0\x5f"
      "\xd2\x41\x08\xd8\x36\x3d\x44\xfc\xd0\xf8\xf3\x64\x78\x99\x76\x2a\x17\x28"
      "\x2a\x19\x14\x45\x2d\x11\xf5\x57\xc2\x8f\x39\x6e\xeb\xdc\x85\x85\x58\xdb"
      "\x02\x76\xd1\x4f\x90\x35\xf2\xb5\xf7\x03\xe5\xbe\x7e\x4a\xcf\x8b\x78\xc2"
      "\x83\x4a\xe5\x80\x5f\xff\xee\x38\xa9\xa0\x03\x3d\x52\x0b\xcf\x6b\x08\xed"
      "\xe5\x08\x99\xd4\xb9\xbd\xf8\x5c\x71\xc5\xde\x25\x03\xda\xb3\x58\xf4\x2a"
      "\x26\x24\xc7\xda\xa9\xed\x44\x03\x9a\xab\x46\x41\x94\x96\x36\x2e\x54\xcf"
      "\xad\x05\xa0\x00\x4a\xc7\x1a\x00\x3d\x7b\x85\xd0\x71\x91\xbe\xd4\xe5\xa8"
      "\x90\x82\x63\x00\x21\x41\x46\xf7\xed\x56\x99\x85\x43\x9b\xaa\x35\x5c\x27"
      "\x66\xdd\x05\x6f\x5d\x79\xe4\x54\xf3\xd8\x73\x09\x5e\x7a\x23\x7b\xc0\x6d"
      "\x03\x5a\x8d\x60\x1f\x21\x74\x6d\x88\x64\x19\xf3\x8b\x34\xa4\x95\x04\x00"
      "\x00\x00\x00\x71\xc2\xf0\xcc\xe8\xc9\x3c\xc1\x7e\x9a\xfa\x31\x4f\xcb\x2b"
      "\xa1\x5d\x64\x6c\x66\xb0\xf6\x50\x21\x82\x9f\x87\xd9\x88\xb4\xe2\xd7\x17"
      "\x53\xb1\x54\x9f\xa7\x34\xf0\xb2\xe5\x6d\xbd\x21\xed\x2e\x09\xd0\xcd\xda"
      "\xd7\x21\x97\x16\x37\xf3\x84\xee\xd3\x03\x45\x97\xc9\x3e\x1c\x52\xf4\x2c"
      "\xad\x0e\xd0\x9c\x39\x5d\xc6\xe9\x70\x36\x60\xfe\xfa\x1c\x80\xf4\x67\x36"
      "\x7c\x00\x6f\x25\xca\xf0\xcb\xce\xfd\x13\xd6\x88\x39\x89\x3e\x39\xc5\x88"
      "\xeb\x03\x29\x05\xf9\x1c\xaf\xa4\x99\x6d\xbf\x0c\x9b\xe9\x65\x4d\xb0\x5f"
      "\xb9\x18\x08\x6c\xc8\x22\x8d\x02\xa3\x09\x2c\x08\x30\xb8\xf5\x87\xa5\x62"
      "\x45\x15\x29\x8b\x2d\x4e\xb2\xbd\xe6\xf9\xa2\xeb\x83\xd5\x3f\x71\x7f\x13"
      "\xfa\x75\x52\xd9\x2c\x51\xdb\xd3\x2e\xa5\x0c\x49\x0e\xcd\x08\x5d\x28\x11"
      "\xa7\x55\x5c\x53\x8c\xff\xff\xff\x7f\x00\x00\x00\x00\xdd\x87\x22\x44\xbf"
      "\xa6\x47\x79\xe0\xf4\x3a\x9c\x27\x7e\x29\x10\xb7\xcc\xdc\x3d\x67\x26\xd3"
      "\x4a\xd2\x10\x10\x33\xa6\x23\xca\x2a\x49\xad\x34\x48\x84\x28\x91\x30\xbc"
      "\x71\xce\xe2\xb7\xde\x62\xbf\x48\x12\x9a\xe1\xaf\x05\x2a\x2d\x46\xa6\x16"
      "\x25\x73\x5a\x9e\xea\x7f\x79\x39\x46\xb3\x22\x9e\x86\x1d\x8e\xa4\x98\x06"
      "\xb3\xf7\xd4\x29\x5f\x6b\x00\x00\x00\x00\x00\x00\xf3\x37\xb1\xce\xb2\xd8"
      "\xa6\x5d\xcd\xcd\x89\x5d\x7b\xa3\x70\x98\xd2\x59\x3f\xda\xae\xf4\x45\xaf"
      "\x5b\xee\x02\x01\x9c\x00\x00\x00\x99\xb1\x3e\xcd\xa2\xa5\xb3\x7d\xe0\x51"
      "\x9e\x97\x4c\xba\x92\xeb\xaf\x0f\x70\x16\x11\xa9\xb0\x27\xce\x04\x34\x0b"
      "\xda\x45\x94\xcc\x90\x49\xc3\xf1\x01\x62\x9a\xb0\x28\x14\x5e\x00\x42\x09"
      "\xeb\xe7\x1a\x6f\xe8\x4a\xf5\x08\x04\x00\x00\x00\x00\x00\x00\x00\x4a\x27"
      "\x21\x33\x54\x96\x4e\x25\x0a\x98\xfe\x35\x76\x76\xf9\x4b\x69\x47\x38\x3e"
      "\x32\x0f\xbb\x11\x18\xf5\x86\xd5\xb9\xb1\xb9\x77\xe1\xe1\xa4\x49\x0f\xf6"
      "\x77\x03\xa9\xb5\x90\x0f\x8a\x6f\x8a\x80\x58\x79\xdd\x91\xec\x5f\xf4\x35"
      "\xb2\x19\xc5\x36\x80\xc0\xae\x04\xdc\xc4\xef\x69\xb9\x8f\xcb\x0d\x6b\x6a"
      "\x03\xa8\xb7\x1a\x66\xb4\xe2\x87\x6d\xc4\xb6\x10\x44\x4b\xf1\x00\x00\x00"
      "\x00\x00\xb0\x46\xb6\xae\x5d\x68\x15\x6b\xcb\xd6\xd8\x79\x3a\xde\x9a\x22"
      "\xac\x8f\xc7\x85\x7e\x5b\xbc\x14\xad\xc4\xe1\x2b\x08\xf3\x50\xc6\x78\x92"
      "\x83\xb9\x99\x0c\x72\xe6\x43\x72\xa1\xf7\x97\x69\xa8\xbd\xc6\x32\xfc\x1a"
      "\x0b\x34\x17\x85\x5d\x8b\x7d\x25\xca\x4d\x40\x4c\x23\x63\x1a\xd3\xd2\xf5"
      "\x5d\xcd\x38\x53\x71\xc8\x61\x70\xa4\xbc\xa5\x8c\x2b\x2b\x4e\xab\xc3\x65"
      "\xf4\x5b\xd1\x0b\xb4\x5b\x0c\x5b\xc3\x54\x45\x6a\x52\xbe\x18\xd9\xb4\x40"
      "\x14\xd2\x0a\x3c\x51\xc8\xf0\x13\xda\xde\x83\x56\x2e\x73\x27\x86\x62\x82"
      "\x9e\x4f\x5a\x9a\xc0\x0f\xd9\x11\x78\x46\x8c\x73\x7f\x08\x72\xd9\x7d\x38"
      "\xd1\x1a\x17\x6b\xe5\xa0\xd7\x29\x4c\x51\xeb\x16\x1e\xdd\xcf\xef\xa8\x83"
      "\x7c\x74\x30\x72\x18\x51\xec\x2a\x10\x7a\xf0\xdf\x6d\x43\xe7\x32\xbb\xc0"
      "\x1e\x76\xc6\x68\x95\xeb\x85\xd3\x67\x98\xd6\x16\x22\x77\x35\x91\xee\x21"
      "\xad\x9f\x6a\x1b\x73\xfa\x9c\xf3\xff\xeb\x8a\x00\xb6\x3a\xf8\x00\xa8\x1d"
      "\x0f\xb8\xaa\x29\xdf\x8b\x8a\xd6\xfb\xaf\xef\xb5\x80\x2a\x23\xcb\xde\xea"
      "\xbc\xed\xa5\xbf\xc5\xff\x2f\xa5\xc1\xd6\x1d\x04\xa1\x32\x47\x94\xc6\xed"
      "\x00\x06\x96\xd9\xf0\x40\x10\xc3\x54\x74\xe6\x90\x54\x5c\x3d\x9b\xd8\x36"
      "\xd4\xce\xf2\x58\x5b\xa6\x16\xe0\x1c\x3d\x00\x00\x00\x00\x00\x00\x00\x00"
      "\x00\x47\x0e\xbc\x6f\x34\x53\xec\xbf\x30\x47\xe4\x54\x7d\x76\x32\xd3\xad"
      "\x21\x79\x8e\x73\x0c\xb5\xd1\xda\x05\x9b\x5b\xdb\x81\x07\x81\x5d\xff\x99"
      "\x5c\x07\x88\x90\x67\x90\x40\x6d\xfb\x4f\x8e\xe9\xf2\x4f\xf9\x42\x33\xe2"
      "\xe6\xe5\x81\xe6\xe5\xde\x33\xa5\xf2\x54\xc9\xa8\xb6\x12\x54\x74\x73\xc3"
      "\x00\x1d\xf3\x92\x8d\xac\x92\x03\xb7\x44\x61\x90\x82\x42\x1a\x8d\xa7\xc0"
      "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x8a\x73\xef"
      "\x40\xcc\xa6\x90\xfb\x75\x95\xc6\x96\x29\x84\xf8\x27\x66\x77\xbe\x6f\x66"
      "\xcb\xdb\xcc\xf1\x89\x64\x33\x80\x8c\x9c\x84\xd7\x4a\xc4\xa7\xc1\x86\xa0"
      "\x4a\x22\x50\x97\x2f\x7a\xcb\x15\x6b\x21\xf9\x82\x6b\x6a\xcb\x7d\xb3\x2c"
      "\x4e\x3b\x3e\xc8\xb5\x9f\xd9\x72\x97\x5e\xdb\x1d\xa8\x72\xd8\x1a\x35\xe4"
      "\xfd\xa2\xf5\xcb\xde\x6b\x40\xbe\xa2\x04\x18\xc6\xe9\xda\xd3\x0b\x79\x1e"
      "\xea\x58\xf5\x3e\x80\xfe\xe4\xdd\x7f\xe0\x83\x73\xea\x27\x84\xfc\xd3\xa6"
      "\x52\x61\xde\x71\xeb\x86\x64\x58\xd2\xc2\x2a",
      1379);
  *(uint64_t*)0x200000000090 = 0x200000000100;
  memcpy((void*)0x200000000100, "GPL\000", 4);
  *(uint32_t*)0x200000000098 = 0;
  *(uint32_t*)0x20000000009c = 0;
  *(uint64_t*)0x2000000000a0 = 0;
  *(uint32_t*)0x2000000000a8 = 0;
  *(uint32_t*)0x2000000000ac = 0;
  memset((void*)0x2000000000b0, 0, 16);
  *(uint32_t*)0x2000000000c0 = 0;
  *(uint32_t*)0x2000000000c4 = 0;
  *(uint32_t*)0x2000000000c8 = -1;
  *(uint32_t*)0x2000000000cc = 8;
  *(uint64_t*)0x2000000000d0 = 0;
  *(uint32_t*)0x2000000000d8 = 0;
  *(uint32_t*)0x2000000000dc = 0x10;
  *(uint64_t*)0x2000000000e0 = 0;
  *(uint32_t*)0x2000000000e8 = 0;
  *(uint32_t*)0x2000000000ec = 0;
  *(uint32_t*)0x2000000000f0 = -1;
  *(uint32_t*)0x2000000000f4 = 0;
  *(uint64_t*)0x2000000000f8 = 0;
  *(uint64_t*)0x200000000100 = 0;
  *(uint32_t*)0x200000000108 = 0x10;
  *(uint32_t*)0x20000000010c = 0;
  *(uint32_t*)0x200000000110 = 0;
  res =
      syscall(__NR_bpf, /*cmd=*/5ul, /*arg=*/0x200000000080ul, /*size=*/0x70ul);
  if (res != -1)
    r[1] = res;
  *(uint32_t*)0x200000000640 = r[0];
  *(uint32_t*)0x200000000644 = r[1];
  memset((void*)0x200000000648, 2, 1);
  syscall(__NR_bpf, /*cmd=*/8ul, /*arg=*/0x200000000640ul, /*size=*/0x10ul);
}
int main(void)
{
  syscall(__NR_mmap, /*addr=*/0x1ffffffff000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x200000000000ul, /*len=*/0x1000000ul,
          /*prot=PROT_WRITE|PROT_READ|PROT_EXEC*/ 7ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x200001000000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  const char* reason;
  (void)reason;
  for (procid = 0; procid < 6; procid++) {
    if (fork() == 0) {
      loop();
    }
  }
  sleep(1000000);
  return 0;
}
