// https://syzkaller.appspot.com/bug?id=8db74500dd3946631798fa62e712fd2bba7f68df
// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE

#include <endian.h>
#include <fcntl.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/stat.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

static long syz_open_dev(volatile long a0, volatile long a1, volatile long a2)
{
  if (a0 == 0xc || a0 == 0xb) {
    char buf[128];
    sprintf(buf, "/dev/%s/%d:%d", a0 == 0xc ? "char" : "block", (uint8_t)a1,
            (uint8_t)a2);
    return open(buf, O_RDWR, 0);
  } else {
    unsigned long nb = a1;
    char buf[1024];
    char* hash;
    strncpy(buf, (char*)a0, sizeof(buf) - 1);
    buf[sizeof(buf) - 1] = 0;
    while ((hash = strchr(buf, '#'))) {
      *hash = '0' + (char)(nb % 10);
      nb /= 10;
    }
    return open(buf, a2 & ~O_CREAT, 0);
  }
}

uint64_t r[1] = {0xffffffffffffffff};

int main(void)
{
  syscall(__NR_mmap, /*addr=*/0x1ffffffff000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x200000000000ul, /*len=*/0x1000000ul,
          /*prot=PROT_WRITE|PROT_READ|PROT_EXEC*/ 7ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x200001000000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  const char* reason;
  (void)reason;
  intptr_t res = 0;
  if (write(1, "executing program\n", sizeof("executing program\n") - 1)) {
  }
  //  syz_open_dev$evdev arguments: [
  //    dev: ptr[in, buffer] {
  //      buffer: {2f 64 65 76 2f 69 6e 70 75 74 2f 65 76 65 6e 74 23 00}
  //      (length 0x12)
  //    }
  //    id: intptr = 0x2 (8 bytes)
  //    flags: open_flags = 0x862b01 (8 bytes)
  //  ]
  //  returns fd_evdev
  memcpy((void*)0x2000000000c0, "/dev/input/event#\000", 18);
  res = -1;
  res = syz_open_dev(
      /*dev=*/0x2000000000c0, /*id=*/2,
      /*flags=O_TRUNC|O_NONBLOCK|O_NOFOLLOW|O_NOCTTY|O_NOATIME|FASYNC|0x800001*/
      0x862b01);
  if (res != -1)
    r[0] = res;
  //  ioctl$EVIOCSFF arguments: [
  //    fd: fd_evdev (resource)
  //    cmd: const = 0x40304580 (4 bytes)
  //    arg: ptr[in, ff_effect] {
  //      ff_effect {
  //        type: ff_effect_type = 0x54 (2 bytes)
  //        id: int16 = 0x1 (2 bytes)
  //        dir: int16 = 0x1 (2 bytes)
  //        trigger: ff_trigger {
  //          button: int16 = 0x0 (2 bytes)
  //          interv: int16 = 0x1 (2 bytes)
  //        }
  //        replay: ff_replay {
  //          len: int16 = 0x60 (2 bytes)
  //          delay: int16 = 0x2 (2 bytes)
  //        }
  //        pad = 0x0 (2 bytes)
  //        u: union ff_effect_u {
  //          period: ff_periodic_effect {
  //            wave: ff_periodic_effect_wave = 0x59 (2 bytes)
  //            period: int16 = 0x0 (2 bytes)
  //            magnit: int16 = 0x8 (2 bytes)
  //            offset: int16 = 0x2 (2 bytes)
  //            phase: int16 = 0x448 (2 bytes)
  //            envelope: ff_envelope {
  //              len: int16 = 0x2 (2 bytes)
  //              level: int16 = 0x8 (2 bytes)
  //              flen: int16 = 0x679c (2 bytes)
  //              flevel: int16 = 0x401 (2 bytes)
  //            }
  //            pad = 0x0 (2 bytes)
  //            custom_len: len = 0x0 (4 bytes)
  //            custom_data: nil
  //          }
  //        }
  //      }
  //    }
  //  ]
  *(uint16_t*)0x200000000b40 = 0x54;
  *(uint16_t*)0x200000000b42 = 1;
  *(uint16_t*)0x200000000b44 = 1;
  *(uint16_t*)0x200000000b46 = 0;
  *(uint16_t*)0x200000000b48 = 1;
  *(uint16_t*)0x200000000b4a = 0x60;
  *(uint16_t*)0x200000000b4c = 2;
  *(uint16_t*)0x200000000b50 = 0x59;
  *(uint16_t*)0x200000000b52 = 0;
  *(uint16_t*)0x200000000b54 = 8;
  *(uint16_t*)0x200000000b56 = 2;
  *(uint16_t*)0x200000000b58 = 0x448;
  *(uint16_t*)0x200000000b5a = 2;
  *(uint16_t*)0x200000000b5c = 8;
  *(uint16_t*)0x200000000b5e = 0x679c;
  *(uint16_t*)0x200000000b60 = 0x401;
  *(uint32_t*)0x200000000b64 = 0;
  *(uint64_t*)0x200000000b68 = 0;
  syscall(__NR_ioctl, /*fd=*/r[0], /*cmd=*/0x40304580,
          /*arg=*/0x200000000b40ul);
  //  write$char_usb arguments: [
  //    fd: fd_char_usb (resource)
  //    buf: ptr[in, buffer] {
  //      buffer: {e2} (length 0x1)
  //    }
  //    count: len = 0x2250 (8 bytes)
  //  ]
  memset((void*)0x200000000040, 226, 1);
  syscall(__NR_write, /*fd=*/r[0], /*buf=*/0x200000000040ul,
          /*count=*/0x2250ul);
  return 0;
}
