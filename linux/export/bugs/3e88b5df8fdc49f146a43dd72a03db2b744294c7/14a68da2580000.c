// https://syzkaller.appspot.com/bug?id=3e88b5df8fdc49f146a43dd72a03db2b744294c7
// autogenerated by syzkaller (https://github.com/google/syzkaller)

#define _GNU_SOURCE

#include <endian.h>
#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/syscall.h>
#include <sys/types.h>
#include <unistd.h>

#ifndef __NR_dup
#define __NR_dup 23
#endif
#ifndef __NR_mkdirat
#define __NR_mkdirat 34
#endif
#ifndef __NR_mmap
#define __NR_mmap 222
#endif
#ifndef __NR_mount
#define __NR_mount 40
#endif
#ifndef __NR_pipe2
#define __NR_pipe2 59
#endif
#ifndef __NR_setsockopt
#define __NR_setsockopt 208
#endif
#ifndef __NR_write
#define __NR_write 64
#endif

uint64_t r[3] = {0xffffffffffffffff, 0xffffffffffffffff, 0xffffffffffffffff};

int main(void)
{
  syscall(__NR_mmap, /*addr=*/0x1ffff000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x20000000ul, /*len=*/0x1000000ul,
          /*prot=PROT_WRITE|PROT_READ|PROT_EXEC*/ 7ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  syscall(__NR_mmap, /*addr=*/0x21000000ul, /*len=*/0x1000ul, /*prot=*/0ul,
          /*flags=MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE*/ 0x32ul,
          /*fd=*/(intptr_t)-1, /*offset=*/0ul);
  const char* reason;
  (void)reason;
  intptr_t res = 0;
  if (write(1, "executing program\n", sizeof("executing program\n") - 1)) {
  }
  //  pipe2$9p arguments: [
  //    pipefd: ptr[out, pipe_9p] {
  //      pipe_9p {
  //        rfd: rfd9p (resource)
  //        wfd: wfd9p (resource)
  //      }
  //    }
  //    flags: pipe_flags = 0x0 (8 bytes)
  //  ]
  res = syscall(__NR_pipe2, /*pipefd=*/0x20000240ul, /*flags=*/0ul);
  if (res != -1) {
    r[0] = *(uint32_t*)0x20000240;
    r[1] = *(uint32_t*)0x20000244;
  }
  //  write$P9_RVERSION arguments: [
  //    fd: wfd9p (resource)
  //    data: ptr[inout, array[ANYUNION]] {
  //      array[ANYUNION] {
  //        union ANYUNION {
  //          ANYBLOB: buffer: {15 00 00 00 65 ff ff 09 7b 00 00 08 00 39 50 32
  //          30 30 30 2e 4c} (length 0x15)
  //        }
  //      }
  //    }
  //    size: bytesize = 0x15 (8 bytes)
  //  ]
  memcpy((void*)0x20000080,
         "\x15\x00\x00\x00\x65\xff\xff\x09\x7b\x00\x00\x08\x00\x39\x50\x32\x30"
         "\x30\x30\x2e\x4c",
         21);
  syscall(__NR_write, /*fd=*/r[1], /*data=*/0x20000080ul, /*size=*/0x15ul);
  //  setsockopt$packet_rx_ring arguments: [
  //    fd: sock_packet (resource)
  //    level: const = 0x107 (4 bytes)
  //    optname: const = 0x5 (4 bytes)
  //    optval: ptr[in, tpacket_req_u] {
  //      union tpacket_req_u {
  //        req: tpacket_req {
  //          tp_block_size: int32 = 0x4 (4 bytes)
  //          tp_block_nr: int32 = 0x80000000 (4 bytes)
  //          tp_frame_size: int32 = 0x1 (4 bytes)
  //          tp_frame_nr: int32 = 0x81 (4 bytes)
  //        }
  //      }
  //    }
  //    optlen: len = 0x10 (8 bytes)
  //  ]
  *(uint32_t*)0x20000140 = 4;
  *(uint32_t*)0x20000144 = 0x80000000;
  *(uint32_t*)0x20000148 = 1;
  *(uint32_t*)0x2000014c = 0x81;
  syscall(__NR_setsockopt, /*fd=*/(intptr_t)-1, /*level=*/0x107, /*optname=*/5,
          /*optval=*/0x20000140ul, /*optlen=*/0x10ul);
  //  dup arguments: [
  //    oldfd: fd (resource)
  //  ]
  //  returns fd
  res = syscall(__NR_dup, /*oldfd=*/r[1]);
  if (res != -1)
    r[2] = res;
  //  write$FUSE_BMAP arguments: [
  //    fd: fd_fuse (resource)
  //    arg: ptr[in, fuse_out_t[fuse_unique, fuse_bmap_out]] {
  //      fuse_out_t[fuse_unique, fuse_bmap_out] {
  //        len: len = 0x18 (4 bytes)
  //        err: fuse_errors = 0x0 (4 bytes)
  //        unique: fuse_unique (resource)
  //        payload: fuse_bmap_out {
  //          block: int64 = 0x0 (8 bytes)
  //        }
  //      }
  //    }
  //    len: bytesize = 0x18 (8 bytes)
  //  ]
  *(uint32_t*)0x20000100 = 0x18;
  *(uint32_t*)0x20000104 = 0;
  *(uint64_t*)0x20000108 = 0;
  *(uint64_t*)0x20000110 = 0;
  syscall(__NR_write, /*fd=*/r[2], /*arg=*/0x20000100ul, /*len=*/0x18ul);
  //  write$FUSE_DIRENTPLUS arguments: [
  //    fd: fd_fuse (resource)
  //    arg: ptr[inout, array[ANYUNION]] {
  //      array[ANYUNION] {
  //        union ANYUNION {
  //          ANYBLOB: buffer: {b0 00 00 00 00 00 00 00 16 59 ec 08 89 41 94 29
  //          aa 5d b9 72 88 b0 f8 a8 7e a8 e6 6d 9a 8b} (length 0x1e)
  //        }
  //      }
  //    }
  //    len: bytesize = 0xb0 (8 bytes)
  //  ]
  memcpy((void*)0x20002100,
         "\xb0\x00\x00\x00\x00\x00\x00\x00\x16\x59\xec\x08\x89\x41\x94\x29\xaa"
         "\x5d\xb9\x72\x88\xb0\xf8\xa8\x7e\xa8\xe6\x6d\x9a\x8b",
         30);
  syscall(__NR_write, /*fd=*/r[2], /*arg=*/0x20002100ul, /*len=*/0xb0ul);
  //  write$FUSE_DIRENTPLUS arguments: [
  //    fd: fd_fuse (resource)
  //    arg: ptr[inout, array[ANYUNION]] {
  //      array[ANYUNION] {
  //        union ANYUNION {
  //          ANYBLOB: buffer: {10} (length 0x1)
  //        }
  //      }
  //    }
  //    len: bytesize = 0x10 (8 bytes)
  //  ]
  memset((void*)0x20000140, 16, 1);
  syscall(__NR_write, /*fd=*/r[2], /*arg=*/0x20000140ul, /*len=*/0x10ul);
  //  mkdirat arguments: [
  //    fd: fd_dir (resource)
  //    path: ptr[in, buffer] {
  //      buffer: {2e 2f 66 69 6c 65 30 00} (length 0x8)
  //    }
  //    mode: open_mode = 0x0 (8 bytes)
  //  ]
  memcpy((void*)0x20000000, "./file0\000", 8);
  syscall(__NR_mkdirat, /*fd=*/0xffffff9c, /*path=*/0x20000000ul, /*mode=*/0ul);
  //  mount$9p_fd arguments: [
  //    src: const = 0x0 (8 bytes)
  //    dst: ptr[in, buffer] {
  //      buffer: {2e 2f 66 69 6c 65 30 00} (length 0x8)
  //    }
  //    type: ptr[in, buffer] {
  //      buffer: {39 70 00} (length 0x3)
  //    }
  //    flags: mount_flags = 0x0 (8 bytes)
  //    opts: ptr[inout, array[ANYUNION]] {
  //      array[ANYUNION] {
  //        union ANYUNION {
  //          ANYBLOB: buffer: {74 72 61 6e 73 3d 66 64 2c 72 66 64 6e 6f 3d}
  //          (length 0xf)
  //        }
  //        union ANYUNION {
  //          ANYRESHEX: ANYRES64 (resource)
  //        }
  //        union ANYUNION {
  //          ANYBLOB: buffer: {2c 77 66 64 6e 6f 3d} (length 0x7)
  //        }
  //        union ANYUNION {
  //          ANYRESHEX: ANYRES64 (resource)
  //        }
  //        union ANYUNION {
  //          ANYBLOB: buffer: {2c 70 6f 73 69 78 61 63 6c} (length 0x9)
  //        }
  //      }
  //    }
  //  ]
  memcpy((void*)0x200003c0, "./file0\000", 8);
  memcpy((void*)0x20000b80, "9p\000", 3);
  memcpy((void*)0x20000580, "trans=fd,rfdno=", 15);
  sprintf((char*)0x2000058f, "0x%016llx", (long long)r[0]);
  memcpy((void*)0x200005a1, ",wfdno=", 7);
  sprintf((char*)0x200005a8, "0x%016llx", (long long)r[2]);
  memcpy((void*)0x200005ba, ",posixacl", 9);
  syscall(__NR_mount, /*src=*/0ul, /*dst=*/0x200003c0ul, /*type=*/0x20000b80ul,
          /*flags=*/0ul, /*opts=*/0x20000580ul);
  return 0;
}
